# 机器人

---
机器人 ----https----> 梯控平台
---

## 乘梯

当机器人有乘梯需求时，可主动向平台发起乘梯请求，平台会根据策略返回电梯标识

### 示例

- 请求

```http request
PUT dispatching/robots/{robotId}/taking

{
    "from": 2,
    "to": 5
}
```

其中：  
robotId：为平台分配给机器人的唯一标识  
报文体中的from/to分别为“发出楼层”和“目标楼层”

- 返回

```json
{
  "code": "1",
  "msg": "Success",
  "result": {
    "elevatorId": "48bf009a-bc31-40e9-a6c0-f3a96f190fa3"
  }
}
```

其中：  
elevatorId：为平台为机器人分配的电梯标识

## 已进梯

当机器人进入电梯后，主动向平台报备

### 示例

- 请求

```http request
PUT dispatching/robots/{robotId}/entering?elevatorId={elevatorId}
```

其中：     
robotId：为平台分配给机器人的唯一标识  
elevatorId：为机器人向平台发起乘梯请求时，平台分配的电梯标识  

- 返回

无

## 已出梯

当机器人从电梯出来后，主动向平台报备

### 示例

- 请求

```http request
PUT dispatching/robots/{robotId}/leaving?elevatorId={elevatorId}
```

其中：  
robotId：为平台分配给机器人的唯一标识  
elevatorId：为机器人向平台发起乘梯请求时，平台分配的电梯标识

- 返回

无

## 释放开门

在目标楼层（出发楼层和到达楼层）到达后，当机器人若无法进出电梯，在保证机器人安全前提下，可向平台发送释放指令。此时电梯会正常关门

### 示例

- 请求

```http request
PUT /dispatching/robots/{robotId}/releasing?elevatorId={elevatorId}
```

其中：  
robotId：为机器标识
elevatorId：为平台分配给机器人乘坐的电梯

- 返回

无

---
梯控平台 ----mqtts----> 机器人
---

## 机器人激活后，可获取连接平台MQTTS信息

机器人在调度平台注册并激活后，可以获取如下信息。将该信息填写到机器从侧的MQTT客户上，即可实现接收平台指令

```json
{
  "clientId": "48bf009a-bc31-40e9-a6c0-f3a96f190fa3",
  "uri": "ssl://10.10.1.167:1884",
  "credential": {
    "username": "r9Y7K4N2",
    "password": "m9c9N8P2Q9",
    "certificates": {
      "ca": "ca",
      "cert": "cert",
      "key": "key"
    }
  },
  "command": "dispatching/48bf009a-bc31-40e9-a6c0-f3a96f190fa3/command",
  "data": "dispatching/48bf009a-bc31-40e9-a6c0-f3a96f190fa3/data",
  "ack": "dispatching/48bf009a-bc31-40e9-a6c0-f3a96f190fa3/ack"
}
```
其中：  
clientId：为平台为机器人分配的唯一标识  
uri：为调度平台提供的MQTT Broker地址  
username/password：为账号、密码  
certificates：为证书相关，联调阶段可以先不考虑  
command：是平台给机器人下发指令的通道  
data：为机器人向平台上报状态的通道（基于当前场景暂时用不上）   
ack：为机器人响应平台下发指令结果通道  

## 指令响应

当机器人收到指令后，执行目标指令，并将指令的执行结果返回给平台

### 示例
```mqtt request
{
	"requestId": "1627003497199",
	"heads": {
		"thingId": "hhhf689a-f4c4-4055-972b-7d7dddab56e5"
	},
	"body": {
		"instructionId": "b7260f61-cf2c-4d18-9ec8-be7e43f5fcf9",
		"statusCode": "0",
		"status": "未知异常"
	}
}
```
其中：  
requestId：为时间戳  
thingId：为robotId，即平台分配给机器人的标识  
instructionId：为ack目标指令的标识  
statusCode：可自定义  
status：可自定义描述  

## 进梯

当电梯到达楼层且电梯运行方向（对于乘梯机器人，需要考虑乘梯方向）与机器人当前状态匹配时，梯控平台会向机器人发起进梯指令

### 示例

- 指令

``` mqtt request
{
	"requestId": "1627003497199",
	"heads": {
		"instructionId": "5bf698c8-21b6-4574-b3b2-4ec512d00b0a",
		"thingId": "hhhf689a-f4c4-4055-972b-7d7dddab56e5"
	},
	"body": "enter"
}

```

其中：  
requestId：为时间戳，精确到毫秒  
instructionId：是该指令的标识，可以用于实现幂等操作  
thingId：为平台分配给机器人的标识  
body：为机器人与平台约定指令格式，此处“enter”字符串表示请机器人进梯  

- 返回

无

## 出梯

当机器人从电梯出来后，主动向平台报备

### 示例

- 指令

``` mqtt request
{
	"requestId": "1627003497199",
	"heads": {
		"instructionId": "5bf698c8-21b6-4574-b3b2-4ec512d00b0a",
		"thingId": "hhhf689a-f4c4-4055-972b-7d7dddab56e5"
	},
	"body": "leave"
}

```

其中：  
requestId：为时间戳，精确到毫秒  
instructionId：是该指令的标识，可以用于实现幂等操作  
thingId：为平台分配给机器人的标识  
body：为机器人与平台约定指令格式，此处“leave“字符串表示请机器人出梯    

- 返回

无

